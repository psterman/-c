# 搜索功能实现方案

## 一、需求概述

在配置面板的搜索标签页中，实现一个统一的搜索功能，能够：
1. 搜索多个数据源（剪贴板历史、提示词模板、配置文件等）
2. 按数据类型分类展示搜索结果
3. 支持按类型过滤和查看
4. 支持跳转到对应的数据项（打开文件、跳转配置等）

## 二、数据源定义

### 2.1 数据源类型枚举

```autohotkey
; 搜索数据类型
SearchDataType := Map(
    "clipboard", "剪贴板历史",
    "template", "提示词模板",
    "config", "配置项",
    "file", "文件路径",
    "hotkey", "快捷键",
    "function", "功能"
)
```

### 2.2 各数据源结构

#### 2.2.1 剪贴板历史（clipboard）
- **来源**：SQLite数据库 `ClipboardHistory` 表
- **搜索字段**：Content（内容）、SourceApp（来源应用）
- **显示字段**：内容预览、来源应用、时间戳
- **跳转动作**：复制到剪贴板、打开剪贴板管理面板

#### 2.2.2 提示词模板（template）
- **来源**：`PromptTemplates` 全局数组
- **搜索字段**：Title（标题）、Content（内容）、Category（分类）
- **显示字段**：标题、分类、内容预览
- **跳转动作**：发送到Cursor、编辑模板、跳转到模板管理标签页

#### 2.2.3 配置项（config）
- **来源**：`CursorShortcut.ini` 配置文件
- **搜索字段**：配置项名称、配置值
- **显示字段**：配置项名称、配置值、所属分类
- **跳转动作**：跳转到对应配置标签页并高亮

#### 2.2.4 文件路径（file）
- **来源**：剪贴板历史中的文件路径、最近访问的文件
- **搜索字段**：文件路径、文件名
- **显示字段**：文件名、完整路径、文件类型
- **跳转动作**：打开文件、打开文件所在文件夹

#### 2.2.5 快捷键（hotkey）
- **来源**：配置文件和全局快捷键映射
- **搜索字段**：快捷键组合、功能名称
- **显示字段**：快捷键、功能名称、描述
- **跳转动作**：跳转到快捷键配置标签页

#### 2.2.6 功能（function）
- **来源**：系统功能列表（如：解释、重构、优化等）
- **搜索字段**：功能名称、功能描述
- **显示字段**：功能名称、描述、快捷键
- **跳转动作**：执行功能、跳转到相关配置

## 三、搜索数据结构

### 3.1 搜索结果项结构

```autohotkey
; 搜索结果项结构
SearchResultItem := {
    DataType: "clipboard",           ; 数据类型
    DataTypeName: "剪贴板历史",      ; 数据类型名称（显示用）
    ID: 123,                         ; 数据项ID（用于跳转）
    Title: "搜索结果标题",            ; 显示标题
    SubTitle: "副标题或描述",         ; 副标题
    Content: "完整内容",             ; 完整内容（用于详情）
    Preview: "内容预览...",           ; 内容预览（ListView显示）
    Metadata: Map(),                 ; 元数据（时间、路径等）
    Action: "jump",                  ; 跳转动作类型
    ActionParams: Map()               ; 跳转参数
}
```

### 3.2 搜索结果分组结构

```autohotkey
; 搜索结果分组
SearchResultGroup := {
    DataType: "clipboard",           ; 数据类型
    DataTypeName: "剪贴板历史",      ; 类型名称
    Count: 5,                        ; 结果数量
    Items: []                         ; 结果项数组
}
```

## 四、搜索核心逻辑

### 4.1 搜索函数架构

```autohotkey
; ===================== 统一搜索函数 =====================
; 参数：
;   Keyword: 搜索关键词
;   DataTypes: 要搜索的数据类型数组（空数组表示搜索所有类型）
;   MaxResults: 每种类型的最大结果数（默认10）
; 返回：搜索结果数组，按类型分组
SearchAllDataSources(Keyword, DataTypes := [], MaxResults := 10) {
    Results := Map()  ; 按类型分组的搜索结果
    
    ; 如果未指定类型，搜索所有类型
    if (DataTypes.Length = 0) {
        DataTypes := ["clipboard", "template", "config", "file", "hotkey", "function"]
    }
    
    ; 并行搜索各个数据源
    for Index, DataType in DataTypes {
        TypeResults := []
        
        switch DataType {
            case "clipboard":
                TypeResults := SearchClipboardHistory(Keyword, MaxResults)
            case "template":
                TypeResults := SearchPromptTemplates(Keyword, MaxResults)
            case "config":
                TypeResults := SearchConfigItems(Keyword, MaxResults)
            case "file":
                TypeResults := SearchFilePaths(Keyword, MaxResults)
            case "hotkey":
                TypeResults := SearchHotkeys(Keyword, MaxResults)
            case "function":
                TypeResults := SearchFunctions(Keyword, MaxResults)
        }
        
        if (TypeResults.Length > 0) {
            Results[DataType] := {
                DataType: DataType,
                DataTypeName: GetDataTypeName(DataType),
                Count: TypeResults.Length,
                Items: TypeResults
            }
        }
    }
    
    return Results
}
```

### 4.2 各数据源搜索实现

#### 4.2.1 搜索剪贴板历史

```autohotkey
; ===================== 搜索剪贴板历史 =====================
SearchClipboardHistory(Keyword, MaxResults := 10) {
    global ClipboardDB
    Results := []
    
    if (!ClipboardDB || ClipboardDB = 0) {
        return Results
    }
    
    KeywordLower := StrLower(Keyword)
    SQL := "SELECT ID, Content, SourceApp, Timestamp, SessionID, ItemIndex FROM ClipboardHistory WHERE Content LIKE ? OR SourceApp LIKE ? ORDER BY Timestamp DESC LIMIT ?"
    
    ST := ClipboardDB.Prepare(SQL)
    if (!ST) {
        return Results
    }
    
    ST.Bind(1, "%" . Keyword . "%")
    ST.Bind(2, "%" . Keyword . "%")
    ST.Bind(3, MaxResults)
    
    while (ST.Step()) {
        ID := ST.Column(0)
        Content := ST.Column(1)
        SourceApp := ST.Column(2)
        Timestamp := ST.Column(3)
        SessionID := ST.Column(4)
        ItemIndex := ST.Column(5)
        
        ; 生成预览文本（截取前100个字符）
        Preview := SubStr(Content, 1, 100)
        if (StrLen(Content) > 100) {
            Preview .= "..."
        }
        
        ; 格式化时间
        TimeFormatted := FormatTime(Timestamp, "yyyy-MM-dd HH:mm:ss")
        
        ResultItem := {
            DataType: "clipboard",
            DataTypeName: "剪贴板历史",
            ID: ID,
            Title: Preview,
            SubTitle: SourceApp ? (SourceApp . " · " . TimeFormatted) : TimeFormatted,
            Content: Content,
            Preview: Preview,
            Metadata: Map(
                "SourceApp", SourceApp,
                "Timestamp", Timestamp,
                "TimeFormatted", TimeFormatted,
                "SessionID", SessionID,
                "ItemIndex", ItemIndex
            ),
            Action: "copy_to_clipboard",
            ActionParams: Map("ID", ID, "Content", Content)
        }
        
        Results.Push(ResultItem)
    }
    
    ST.Free()
    return Results
}
```

#### 4.2.2 搜索提示词模板

```autohotkey
; ===================== 搜索提示词模板 =====================
SearchPromptTemplates(Keyword, MaxResults := 10) {
    global PromptTemplates
    Results := []
    
    if (!IsSet(PromptTemplates) || PromptTemplates.Length = 0) {
        return Results
    }
    
    KeywordLower := StrLower(Keyword)
    Count := 0
    
    for Index, Template in PromptTemplates {
        if (Count >= MaxResults) {
            break
        }
        
        ; 搜索标题、内容、分类
        TitleMatch := InStr(StrLower(Template.Title), KeywordLower)
        ContentMatch := InStr(StrLower(Template.Content), KeywordLower)
        CategoryMatch := InStr(StrLower(Template.Category), KeywordLower)
        
        if (TitleMatch || ContentMatch || CategoryMatch) {
            ; 生成内容预览
            ContentPreview := SubStr(Template.Content, 1, 80)
            if (StrLen(Template.Content) > 80) {
                ContentPreview .= "..."
            }
            
            ResultItem := {
                DataType: "template",
                DataTypeName: "提示词模板",
                ID: Template.ID,
                Title: Template.Title,
                SubTitle: Template.Category . " · " . ContentPreview,
                Content: Template.Content,
                Preview: ContentPreview,
                Metadata: Map(
                    "Category", Template.Category,
                    "Icon", Template.Icon,
                    "FunctionCategory", Template.HasProp("FunctionCategory") ? Template.FunctionCategory : "",
                    "Series", Template.HasProp("Series") ? Template.Series : ""
                ),
                Action: "send_to_cursor",
                ActionParams: Map("TemplateID", Template.ID, "Template", Template)
            }
            
            Results.Push(ResultItem)
            Count++
        }
    }
    
    return Results
}
```

#### 4.2.3 搜索配置项

```autohotkey
; ===================== 搜索配置项 =====================
SearchConfigItems(Keyword, MaxResults := 10) {
    global ConfigFile
    Results := []
    
    if (!FileExist(ConfigFile)) {
        return Results
    }
    
    KeywordLower := StrLower(Keyword)
    Count := 0
    
    ; 定义配置项映射（配置项名称 -> 所属标签页）
    ConfigSections := Map(
        "General", "general",
        "Settings", "general",
        "Prompts", "prompts",
        "Hotkeys", "hotkeys",
        "Appearance", "appearance",
        "Advanced", "advanced"
    )
    
    ; 读取所有配置节
    for SectionName, TabName in ConfigSections {
        try {
            ; 获取节下的所有键
            SectionKeys := IniRead(ConfigFile, SectionName)
            if (SectionKeys) {
                ; 解析键值对（IniRead返回的是字符串，需要解析）
                Loop Parse, SectionKeys, "`n" {
                    if (Count >= MaxResults) {
                        break
                    }
                    
                    Line := Trim(A_LoopField)
                    if (Line = "") {
                        continue
                    }
                    
                    ; 解析键值对（格式：Key=Value）
                    KeyValuePos := InStr(Line, "=")
                    if (KeyValuePos > 0) {
                        Key := Trim(SubStr(Line, 1, KeyValuePos - 1))
                        Value := Trim(SubStr(Line, KeyValuePos + 1))
                        
                        ; 搜索键名和值
                        KeyMatch := InStr(StrLower(Key), KeywordLower)
                        ValueMatch := InStr(StrLower(Value), KeywordLower)
                        
                        if (KeyMatch || ValueMatch) {
                            ; 截取值预览
                            ValuePreview := SubStr(Value, 1, 60)
                            if (StrLen(Value) > 60) {
                                ValuePreview .= "..."
                            }
                            
                            ResultItem := {
                                DataType: "config",
                                DataTypeName: "配置项",
                                ID: SectionName . "." . Key,
                                Title: Key,
                                SubTitle: SectionName . " · " . ValuePreview,
                                Content: Value,
                                Preview: ValuePreview,
                                Metadata: Map(
                                    "Section", SectionName,
                                    "Key", Key,
                                    "TabName", TabName
                                ),
                                Action: "jump_to_config",
                                ActionParams: Map("TabName", TabName, "Section", SectionName, "Key", Key)
                            }
                            
                            Results.Push(ResultItem)
                            Count++
                        }
                    }
                }
            }
        } catch {
            ; 忽略读取错误
        }
    }
    
    return Results
}
```

#### 4.2.4 搜索文件路径

```autohotkey
; ===================== 搜索文件路径 =====================
SearchFilePaths(Keyword, MaxResults := 10) {
    global ClipboardDB
    Results := []
    
    KeywordLower := StrLower(Keyword)
    Count := 0
    
    ; 从剪贴板历史中提取文件路径
    if (ClipboardDB && ClipboardDB != 0) {
        SQL := "SELECT DISTINCT Content, Timestamp FROM ClipboardHistory WHERE Content LIKE ? OR Content LIKE ? ORDER BY Timestamp DESC LIMIT ?"
        ST := ClipboardDB.Prepare(SQL)
        if (ST) {
            ; 搜索路径格式（Windows路径、URL等）
            ST.Bind(1, "%" . Keyword . "%")
            ST.Bind(2, "file://%")
            ST.Bind(3, MaxResults * 2)  ; 多查询一些，因为需要过滤
            
            while (ST.Step() && Count < MaxResults) {
                Content := ST.Column(0)
                Timestamp := ST.Column(1)
                
                ; 检查是否为文件路径
                if (IsFilePath(Content)) {
                    SplitPath(Content, &FileName, &DirPath, &Ext, &NameNoExt)
                    
                    ; 检查文件名或路径是否匹配关键词
                    if (InStr(StrLower(FileName), KeywordLower) || InStr(StrLower(Content), KeywordLower)) {
                        ResultItem := {
                            DataType: "file",
                            DataTypeName: "文件路径",
                            ID: Content,
                            Title: FileName,
                            SubTitle: DirPath . " · " . (Ext ? Ext : "文件"),
                            Content: Content,
                            Preview: Content,
                            Metadata: Map(
                                "FilePath", Content,
                                "FileName", FileName,
                                "DirPath", DirPath,
                                "Ext", Ext,
                                "Timestamp", Timestamp
                            ),
                            Action: "open_file",
                            ActionParams: Map("FilePath", Content)
                        }
                        
                        Results.Push(ResultItem)
                        Count++
                    }
                }
            }
            
            ST.Free()
        }
    }
    
    return Results
}

; ===================== 判断是否为文件路径 =====================
IsFilePath(Path) {
    ; 检查Windows路径格式（C:\、\\server\等）
    if (RegExMatch(Path, "^(?:[A-Za-z]:\\|\\\\).*")) {
        return FileExist(Path) || DirExist(Path)
    }
    
    ; 检查URL格式
    if (RegExMatch(Path, "^(?:https?|file)://.*")) {
        return true
    }
    
    ; 检查相对路径（以.\或..\开头）
    if (RegExMatch(Path, "^(?:\.\.?[/\\]).*")) {
        return FileExist(Path) || DirExist(Path)
    }
    
    return false
}
```

#### 4.2.5 搜索快捷键

```autohotkey
; ===================== 搜索快捷键 =====================
SearchHotkeys(Keyword, MaxResults := 10) {
    global HotkeyESC, HotkeyC, HotkeyV, HotkeyX, HotkeyE, HotkeyR, HotkeyO, HotkeyQ, HotkeyZ, HotkeyT
    global SplitHotkey, BatchHotkey
    Results := []
    
    KeywordLower := StrLower(Keyword)
    Count := 0
    
    ; 定义快捷键映射
    HotkeyMap := Map(
        "关闭面板", Map("Hotkey", HotkeyESC, "Function", "关闭面板", "Description", "关闭快捷操作面板"),
        "连续复制", Map("Hotkey", HotkeyC, "Function", "连续复制", "Description", "CapsLock+C 连续复制内容"),
        "合并粘贴", Map("Hotkey", HotkeyV, "Function", "合并粘贴", "Description", "CapsLock+V 合并粘贴所有复制的内容"),
        "剪贴板管理", Map("Hotkey", HotkeyX, "Function", "剪贴板管理", "Description", "CapsLock+X 打开剪贴板管理面板"),
        "解释", Map("Hotkey", HotkeyE, "Function", "解释", "Description", "CapsLock+E 解释代码"),
        "重构", Map("Hotkey", HotkeyR, "Function", "重构", "Description", "CapsLock+R 重构代码"),
        "优化", Map("Hotkey", HotkeyO, "Function", "优化", "Description", "CapsLock+O 优化代码"),
        "配置", Map("Hotkey", HotkeyQ, "Function", "配置", "Description", "CapsLock+Q 打开配置面板"),
        "语音输入", Map("Hotkey", HotkeyZ, "Function", "语音输入", "Description", "CapsLock+Z 语音输入"),
        "区域截图", Map("Hotkey", HotkeyT, "Function", "区域截图", "Description", "CapsLock+T 区域截图"),
        "分割代码", Map("Hotkey", SplitHotkey, "Function", "分割代码", "Description", "CapsLock+" . SplitHotkey . " 分割代码"),
        "批量操作", Map("Hotkey", BatchHotkey, "Function", "批量操作", "Description", "CapsLock+" . BatchHotkey . " 批量操作")
    )
    
    for FunctionName, HotkeyInfo in HotkeyMap {
        ; 搜索功能名称、快捷键、描述
        FunctionMatch := InStr(StrLower(FunctionName), KeywordLower)
        HotkeyMatch := InStr(StrLower(HotkeyInfo["Hotkey"]), KeywordLower)
        DescMatch := InStr(StrLower(HotkeyInfo["Description"]), KeywordLower)
        
        if (FunctionMatch || HotkeyMatch || DescMatch) {
            if (Count >= MaxResults) {
                break
            }
            
            HotkeyDisplay := "CapsLock+" . HotkeyInfo["Hotkey"]
            
            ResultItem := {
                DataType: "hotkey",
                DataTypeName: "快捷键",
                ID: FunctionName,
                Title: FunctionName,
                SubTitle: HotkeyDisplay . " · " . HotkeyInfo["Description"],
                Content: HotkeyInfo["Description"],
                Preview: HotkeyDisplay,
                Metadata: Map(
                    "Hotkey", HotkeyInfo["Hotkey"],
                    "Function", HotkeyInfo["Function"],
                    "Description", HotkeyInfo["Description"]
                ),
                Action: "jump_to_hotkey_config",
                ActionParams: Map("Function", FunctionName)
            }
            
            Results.Push(ResultItem)
            Count++
        }
    }
    
    return Results
}
```

#### 4.2.6 搜索功能

```autohotkey
; ===================== 搜索功能 =====================
SearchFunctions(Keyword, MaxResults := 10) {
    Results := []
    
    KeywordLower := StrLower(Keyword)
    Count := 0
    
    ; 定义功能列表
    Functions := [
        Map("Name", "解释代码", "Description", "使用AI解释代码逻辑", "Category", "AI功能"),
        Map("Name", "重构代码", "Description", "使用AI重构代码", "Category", "AI功能"),
        Map("Name", "优化代码", "Description", "使用AI优化代码性能", "Category", "AI功能"),
        Map("Name", "剪贴板管理", "Description", "管理剪贴板历史记录", "Category", "工具功能"),
        Map("Name", "语音输入", "Description", "使用语音输入文本", "Category", "工具功能"),
        Map("Name", "语音搜索", "Description", "使用语音搜索", "Category", "工具功能"),
        Map("Name", "区域截图", "Description", "截取屏幕区域", "Category", "工具功能"),
        Map("Name", "模板管理", "Description", "管理提示词模板", "Category", "配置功能")
    ]
    
    for Index, Func in Functions {
        if (Count >= MaxResults) {
            break
        }
        
        NameMatch := InStr(StrLower(Func["Name"]), KeywordLower)
        DescMatch := InStr(StrLower(Func["Description"]), KeywordLower)
        CategoryMatch := InStr(StrLower(Func["Category"]), KeywordLower)
        
        if (NameMatch || DescMatch || CategoryMatch) {
            ResultItem := {
                DataType: "function",
                DataTypeName: "功能",
                ID: Func["Name"],
                Title: Func["Name"],
                SubTitle: Func["Category"] . " · " . Func["Description"],
                Content: Func["Description"],
                Preview: Func["Description"],
                Metadata: Map(
                    "Category", Func["Category"],
                    "Description", Func["Description"]
                ),
                Action: "execute_function",
                ActionParams: Map("FunctionName", Func["Name"])
            }
            
            Results.Push(ResultItem)
            Count++
        }
    }
    
    return Results
}
```

### 4.3 辅助函数

```autohotkey
; ===================== 获取数据类型名称 =====================
GetDataTypeName(DataType) {
    SearchDataType := Map(
        "clipboard", "剪贴板历史",
        "template", "提示词模板",
        "config", "配置项",
        "file", "文件路径",
        "hotkey", "快捷键",
        "function", "功能"
    )
    
    return SearchDataType.Has(DataType) ? SearchDataType[DataType] : "未知类型"
}
```

## 五、ListView展示逻辑

### 5.1 ListView列定义

```autohotkey
; ListView列：类型 | 标题 | 副标题 | 预览
; 列索引：1=类型，2=标题，3=副标题，4=预览
```

### 5.2 刷新ListView函数

```autohotkey
; ===================== 刷新搜索结果ListView =====================
RefreshSearchResultsListView(SearchResults, FilterType := "") {
    global SearchResultsListView
    
    if (!SearchResultsListView) {
        return
    }
    
    ; 清空列表
    try {
        SearchResultsListView.Delete()
    } catch {
    }
    
    ; 如果指定了过滤类型，只显示该类型的结果
    if (FilterType != "") {
        if (SearchResults.Has(FilterType)) {
            Group := SearchResults[FilterType]
            for Index, Item in Group.Items {
                AddSearchResultItem(SearchResultsListView, Item)
            }
        }
    } else {
        ; 显示所有类型的结果，按类型分组
        ; 定义显示顺序
        DisplayOrder := ["clipboard", "template", "config", "file", "hotkey", "function"]
        
        for Index, DataType in DisplayOrder {
            if (SearchResults.Has(DataType)) {
                Group := SearchResults[DataType]
                
                ; 添加类型分组标题（可选，如果需要分组显示）
                ; 这里简化处理，直接添加所有结果
                for ItemIndex, Item in Group.Items {
                    AddSearchResultItem(SearchResultsListView, Item)
                }
            }
        }
    }
    
    ; 自动调整列宽
    SearchResultsListView.ModifyCol(1, "AutoHdr")
    SearchResultsListView.ModifyCol(2, "AutoHdr")
    SearchResultsListView.ModifyCol(3, "AutoHdr")
    SearchResultsListView.ModifyCol(4, "AutoHdr")
}

; ===================== 添加搜索结果项到ListView =====================
AddSearchResultItem(ListView, Item) {
    ; 列：类型 | 标题 | 副标题 | 预览
    ListView.Add("", Item.DataTypeName, Item.Title, Item.SubTitle, Item.Preview)
    
    ; 保存结果项数据到ListView行数据（通过行索引关联）
    RowIndex := ListView.GetCount()
    ; 注意：AutoHotkey v2的ListView不直接支持行数据，需要通过全局Map存储
    global SearchResultsData
    if (!IsSet(SearchResultsData)) {
        global SearchResultsData := Map()
    }
    SearchResultsData[RowIndex] := Item
}
```

## 六、过滤和分类功能

### 6.1 类型过滤按钮

```autohotkey
; ===================== 创建类型过滤按钮 =====================
CreateSearchTypeFilters(ConfigGUI, X, Y, W) {
    global SearchTypeFilterButtons, SearchCurrentFilterType
    
    SearchTypeFilterButtons := []
    SearchCurrentFilterType := ""  ; 空字符串表示显示所有类型
    
    ; 定义类型按钮
    Types := [
        {Key: "", Name: "全部"},
        {Key: "clipboard", Name: "剪贴板"},
        {Key: "template", Name: "模板"},
        {Key: "config", Name: "配置"},
        {Key: "file", Name: "文件"},
        {Key: "hotkey", Name: "快捷键"},
        {Key: "function", Name: "功能"}
    ]
    
    ButtonWidth := 80
    ButtonHeight := 30
    ButtonSpacing := 10
    CurrentX := X
    
    for Index, Type in Types {
        FilterBtn := ConfigGUI.Add("Button", "x" . CurrentX . " y" . Y . " w" . ButtonWidth . " h" . ButtonHeight . " vSearchFilter" . Type.Key, Type.Name)
        FilterBtn.SetFont("s10", "Segoe UI")
        FilterBtn.OnEvent("Click", CreateSearchFilterHandler(Type.Key))
        SearchTypeFilterButtons.Push(FilterBtn)
        
        CurrentX += ButtonWidth + ButtonSpacing
    }
}

; ===================== 创建过滤按钮事件处理器 =====================
CreateSearchFilterHandler(FilterType) {
    return (*) => {
        global SearchCurrentFilterType, SearchResultsCache
        
        SearchCurrentFilterType := FilterType
        
        ; 更新按钮样式（高亮当前选中的按钮）
        UpdateSearchFilterButtons(FilterType)
        
        ; 刷新ListView显示
        if (IsSet(SearchResultsCache)) {
            RefreshSearchResultsListView(SearchResultsCache, FilterType)
        }
    }
}

; ===================== 更新过滤按钮样式 =====================
UpdateSearchFilterButtons(ActiveType) {
    global SearchTypeFilterButtons
    
    for Index, Btn in SearchTypeFilterButtons {
        if (Btn) {
            ; 根据是否为活动按钮设置不同样式
            ; 这里简化处理，实际应该使用Material风格按钮
        }
    }
}
```

## 七、跳转功能实现

### 7.1 跳转动作处理

```autohotkey
; ===================== 处理搜索结果跳转 =====================
HandleSearchResultAction(Item) {
    switch Item.Action {
        case "copy_to_clipboard":
            ; 复制到剪贴板
            A_Clipboard := Item.Content
            TrayTip("提示", "已复制到剪贴板", "Iconi 1")
            
        case "send_to_cursor":
            ; 发送模板到Cursor
            Template := Item.ActionParams["Template"]
            SendTemplateToCursorWithKey("", Template)
            
        case "jump_to_config":
            ; 跳转到配置标签页
            TabName := Item.ActionParams["TabName"]
            Section := Item.ActionParams["Section"]
            Key := Item.ActionParams["Key"]
            JumpToConfigItem(TabName, Section, Key)
            
        case "open_file":
            ; 打开文件
            FilePath := Item.ActionParams["FilePath"]
            try {
                Run(FilePath)
            } catch {
                TrayTip("错误", "无法打开文件: " . FilePath, "Iconx 2")
            }
            
        case "jump_to_hotkey_config":
            ; 跳转到快捷键配置
            FunctionName := Item.ActionParams["Function"]
            JumpToHotkeyConfig(FunctionName)
            
        case "execute_function":
            ; 执行功能
            FunctionName := Item.ActionParams["FunctionName"]
            ExecuteFunction(FunctionName)
    }
}

; ===================== 跳转到配置项 =====================
JumpToConfigItem(TabName, Section, Key) {
    global GuiID_ConfigGUI
    
    ; 切换到对应标签页
    SwitchTab(TabName)
    
    ; 高亮对应的配置项（需要根据具体实现）
    ; 这里简化处理，实际需要根据控件名称定位并高亮
}

; ===================== 跳转到快捷键配置 =====================
JumpToHotkeyConfig(FunctionName) {
    ; 切换到快捷键标签页
    SwitchTab("hotkeys")
    
    ; 高亮对应的快捷键配置项
    ; 需要根据具体实现定位控件
}

; ===================== 执行功能 =====================
ExecuteFunction(FunctionName) {
    switch FunctionName {
        case "解释代码":
            ; 触发解释功能
            Send("^+e")  ; 假设快捷键
        case "重构代码":
            Send("^+r")
        case "优化代码":
            Send("^+o")
        ; ... 其他功能
    }
}
```

### 7.2 ListView双击事件

```autohotkey
; ===================== 搜索结果ListView双击事件 =====================
OnSearchResultDoubleClick(*) {
    global SearchResultsListView, SearchResultsData
    
    SelectedRow := SearchResultsListView.GetNext()
    if (SelectedRow = 0) {
        return
    }
    
    ; 获取对应的结果项
    if (SearchResultsData.Has(SelectedRow)) {
        Item := SearchResultsData[SelectedRow]
        HandleSearchResultAction(Item)
    }
}
```

## 八、搜索输入框事件

### 8.1 输入框变化事件

```autohotkey
; ===================== 搜索输入框变化事件 =====================
OnSearchInputChange(*) {
    global SearchHistoryEdit, SearchResultsCache, SearchDebounceTimer
    
    ; 防抖处理：延迟500ms执行搜索
    if (SearchDebounceTimer != 0) {
        SetTimer(SearchDebounceTimer, 0)
    }
    
    SearchDebounceTimer := (*) => {
        global SearchHistoryEdit, SearchResultsCache
        
        Keyword := SearchHistoryEdit.Value
        if (Keyword = "") {
            ; 清空结果
            RefreshSearchResultsListView(Map(), "")
            return
        }
        
        ; 执行搜索
        SearchResultsCache := SearchAllDataSources(Keyword)
        
        ; 刷新ListView
        RefreshSearchResultsListView(SearchResultsCache, "")
    }
    
    SetTimer(SearchDebounceTimer, -500)  ; 500ms延迟
}
```

## 九、数据缓存机制

### 9.1 搜索结果缓存

```autohotkey
; 全局变量
global SearchResultsCache := Map()  ; 缓存搜索结果
global SearchLastKeyword := ""      ; 上次搜索关键词
```

### 9.2 缓存更新策略

- 当搜索关键词变化时，清除缓存并重新搜索
- 当数据源更新时（如新增剪贴板记录），可选择清除缓存或增量更新

## 十、性能优化建议

1. **防抖搜索**：输入框变化时延迟500ms执行搜索，避免频繁查询
2. **结果限制**：每种类型最多返回10-20条结果
3. **异步搜索**：对于大数据源（如剪贴板历史），可以考虑异步搜索
4. **索引优化**：数据库查询使用索引字段
5. **缓存机制**：相同关键词的搜索结果可以缓存

## 十一、扩展性设计

### 11.1 新增数据源

要添加新的数据源，只需：
1. 在 `SearchDataType` 中添加新类型
2. 实现对应的 `SearchXXX()` 函数
3. 在 `SearchAllDataSources()` 中添加对应的 case
4. 实现对应的跳转动作处理

### 11.2 自定义搜索逻辑

可以为每种数据类型定义自定义的搜索逻辑：
- 精确匹配
- 模糊匹配
- 正则表达式匹配
- 多关键词AND/OR逻辑

## 十二、总结

本方案提供了一个完整的搜索系统架构，支持：
- ✅ 多数据源统一搜索
- ✅ 按类型分类展示
- ✅ 类型过滤功能
- ✅ 结果跳转功能
- ✅ 性能优化机制
- ✅ 易于扩展的设计

实现时需要注意：
1. 数据库查询的性能优化
2. 大量结果时的分页或虚拟滚动
3. 搜索结果的排序策略（相关性、时间等）
4. 用户体验优化（加载提示、空结果提示等）
