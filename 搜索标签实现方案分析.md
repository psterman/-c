# 搜索标签实现方案分析

## 需求概述
在配置面板中添加一个"搜索"标签，位于"高级"标签下方，包含：
- 搜索输入框
- ListView显示搜索历史数据
- 数据字段：名称、位置、搜索时间、创建时间、修改时间（没有就为空）、类型

## 构建难度评估

### 整体难度：⭐⭐⭐ (中等)

**优势：**
1. ✅ 已有成熟的标签页架构模式可参考
2. ✅ 已有SQLite数据库集成（Class_SQLiteDB）
3. ✅ 已有ListView使用示例（模板管理）
4. ✅ 代码结构清晰，便于扩展

**挑战：**
1. ⚠️ 需要创建新的数据库表结构
2. ⚠️ 需要实现搜索数据的存储逻辑（何时记录搜索）
3. ⚠️ 需要处理文件时间信息的获取（创建时间、修改时间）
4. ⚠️ 需要设计搜索数据的来源（从哪里获取搜索记录）

## SQLite实现方案

### 第一步：数据库表结构设计

```sql
CREATE TABLE IF NOT EXISTS SearchHistory (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    Name TEXT NOT NULL,                    -- 名称
    Path TEXT NOT NULL,                    -- 位置（文件路径或URL）
    SearchTime DATETIME DEFAULT CURRENT_TIMESTAMP,  -- 搜索时间
    CreateTime TEXT,                       -- 创建时间（文件时间，可为空）
    ModifyTime TEXT,                       -- 修改时间（文件时间，可为空）
    Type TEXT,                             -- 类型（文件、文件夹、URL等）
    Content TEXT                           -- 搜索内容（可选，用于记录搜索关键词）
);
```

### 第二步：扩展数据库初始化函数

在 `InitSQLiteDB()` 函数中添加新表的创建逻辑：

**位置：** `CursorHelper (1).ahk` 约第1782行 `InitSQLiteDB()` 函数内

**添加代码：**
```autohotkey
; 创建 SearchHistory 表（如果不存在）
SQL := "CREATE TABLE IF NOT EXISTS SearchHistory (ID INTEGER PRIMARY KEY AUTOINCREMENT, Name TEXT NOT NULL, Path TEXT NOT NULL, SearchTime DATETIME DEFAULT CURRENT_TIMESTAMP, CreateTime TEXT, ModifyTime TEXT, Type TEXT, Content TEXT)"
if (!ClipboardDB.Exec(SQL)) {
    TrayTip("警告", "创建搜索历史表失败: " . ClipboardDB.ErrorMsg, "Iconx 3")
}
```

### 第三步：创建搜索历史记录函数

**功能：** 向数据库插入搜索记录

```autohotkey
; ===================== 添加搜索历史记录 =====================
AddSearchHistory(Name, Path, Content := "", Type := "") {
    global ClipboardDB
    
    if (!ClipboardDB || ClipboardDB = 0) {
        return false
    }
    
    ; 获取文件时间信息（如果Path是文件路径）
    CreateTime := ""
    ModifyTime := ""
    if (FileExist(Path)) {
        try {
            FileGetTime(Path, &ModifyTime, "M")  ; 修改时间
            FileGetTime(Path, &CreateTime, "C")  ; 创建时间
        } catch {
            ; 如果获取失败，保持为空
        }
    }
    
    ; 如果没有指定类型，根据路径判断
    if (Type = "") {
        if (InStr(Path, "http://") || InStr(Path, "https://")) {
            Type := "URL"
        } else if (DirExist(Path)) {
            Type := "文件夹"
        } else if (FileExist(Path)) {
            SplitPath(Path, &FileName, &Dir, &Ext, &NameNoExt)
            Type := Ext ? Ext : "文件"
        } else {
            Type := "未知"
        }
    }
    
    ; 插入数据
    SQL := "INSERT INTO SearchHistory (Name, Path, CreateTime, ModifyTime, Type, Content) VALUES (?, ?, ?, ?, ?, ?)"
    ST := ClipboardDB.Prepare(SQL)
    if (!ST) {
        return false
    }
    
    ST.Bind(1, Name)
    ST.Bind(2, Path)
    ST.Bind(3, CreateTime ? CreateTime : "")
    ST.Bind(4, ModifyTime ? ModifyTime : "")
    ST.Bind(5, Type)
    ST.Bind(6, Content)
    
    if (!ST.Step()) {
        ST.Free()
        return false
    }
    
    ST.Free()
    return true
}
```

### 第四步：查询搜索历史函数

**功能：** 从数据库获取搜索历史记录

```autohotkey
; ===================== 获取搜索历史记录 =====================
GetSearchHistory(Limit := 100) {
    global ClipboardDB
    
    if (!ClipboardDB || ClipboardDB = 0) {
        return []
    }
    
    Results := []
    SQL := "SELECT ID, Name, Path, SearchTime, CreateTime, ModifyTime, Type, Content FROM SearchHistory ORDER BY SearchTime DESC LIMIT ?"
    ST := ClipboardDB.Prepare(SQL)
    if (!ST) {
        return Results
    }
    
    ST.Bind(1, Limit)
    
    while (ST.Step()) {
        Row := {
            ID: ST.Column(0),
            Name: ST.Column(1),
            Path: ST.Column(2),
            SearchTime: ST.Column(3),
            CreateTime: ST.Column(4),
            ModifyTime: ST.Column(5),
            Type: ST.Column(6),
            Content: ST.Column(7)
        }
        Results.Push(Row)
    }
    
    ST.Free()
    return Results
}
```

## 代码实现步骤

### 步骤1：添加搜索标签按钮

**位置：** `CursorHelper (1).ahk` 约第11417行（在高级标签后）

**修改：**
```autohotkey
TabAdvanced := CreateMaterialRadioButton(ConfigGUI, 5, TabY + (TabHeight + TabSpacing) * 4, TabRadioWidth, TabRadioHeight, "TabAdvanced", GetText("tab_advanced"), TabRadioGroup, 10, false)
TabRadioGroup.Push(TabAdvanced)
TabAdvanced.OnEvent("Click", (*) => SwitchTab("advanced"))

; 添加搜索标签
TabSearch := CreateMaterialRadioButton(ConfigGUI, 5, TabY + (TabHeight + TabSpacing) * 5, TabRadioWidth, TabRadioHeight, "TabSearch", "搜索", TabRadioGroup, 10, false)
TabRadioGroup.Push(TabSearch)
TabSearch.OnEvent("Click", (*) => SwitchTab("search"))
```

### 步骤2：更新ConfigTabs映射

**位置：** 约第11433行

**修改：**
```autohotkey
ConfigTabs := Map(
    "general", TabGeneral,
    "appearance", TabAppearance,
    "prompts", TabPrompts,
    "hotkeys", TabHotkeys,
    "advanced", TabAdvanced,
    "search", TabSearch  ; 添加搜索标签
)
```

### 步骤3：初始化搜索标签控件数组

**位置：** 全局变量声明区域（约第120行附近）

**添加：**
```autohotkey
global SearchTabControls := []
```

### 步骤4：创建搜索标签页函数

**位置：** 在 `CreateAdvancedTab` 函数之后（约第10277行后）

**添加：**
```autohotkey
; ===================== 创建搜索标签页 =====================
CreateSearchTab(ConfigGUI, X, Y, W, H) {
    global SearchTabControls, UI_Colors, ThemeMode
    
    ; 初始化控件数组
    if (!IsSet(SearchTabControls)) {
        SearchTabControls := []
    }
    
    ; 创建标签页面板（默认隐藏）
    SearchTabPanel := ConfigGUI.Add("Text", "x" . X . " y" . Y . " w" . W . " h" . H . " Background" . UI_Colors.Background . " vSearchTabPanel", "")
    SearchTabPanel.Visible := false
    SearchTabControls.Push(SearchTabPanel)
    
    ; 标题
    Title := ConfigGUI.Add("Text", "x" . (X + 30) . " y" . (Y + 20) . " w" . (W - 60) . " h30 c" . UI_Colors.Text, "搜索历史")
    Title.SetFont("s16 Bold", "Segoe UI")
    SearchTabControls.Push(Title)
    
    ; 搜索输入框
    YPos := Y + 70
    LabelSearch := ConfigGUI.Add("Text", "x" . (X + 30) . " y" . YPos . " w200 h25 c" . UI_Colors.Text, "搜索关键词：")
    LabelSearch.SetFont("s11", "Segoe UI")
    SearchTabControls.Push(LabelSearch)
    
    YPos += 30
    ; 根据主题模式设置输入框颜色
    if (!IsSet(ThemeMode) || ThemeMode = "") {
        ThemeMode := "dark"
    }
    if (ThemeMode = "dark") {
        InputBgColor := "2d2d30"
        InputTextColor := "FFFFFF"
    } else {
        InputBgColor := UI_Colors.InputBg
        InputTextColor := UI_Colors.Text
    }
    global SearchHistoryEdit := ConfigGUI.Add("Edit", "x" . (X + 30) . " y" . YPos . " w" . (W - 100) . " h30 vSearchHistoryEdit Background" . InputBgColor . " c" . InputTextColor, "")
    SearchHistoryEdit.SetFont("s11", "Segoe UI")
    SearchHistoryEdit.OnEvent("Change", OnSearchHistoryFilter)
    SearchTabControls.Push(SearchHistoryEdit)
    
    ; ListView
    YPos += 50
    ListViewHeight := H - (YPos - Y) - 30
    ListViewTextColor := (ThemeMode = "dark") ? "FFFFFF" : UI_Colors.Text
    global SearchHistoryListView := ConfigGUI.Add("ListView", "x" . (X + 30) . " y" . YPos . " w" . (W - 60) . " h" . ListViewHeight . " vSearchHistoryListView Background" . UI_Colors.InputBg . " c" . ListViewTextColor . " -Multi +ReadOnly", ["名称", "位置", "搜索时间", "创建时间", "修改时间", "类型"])
    SearchHistoryListView.SetFont("s10 c" . ListViewTextColor, "Segoe UI")
    SearchTabControls.Push(SearchHistoryListView)
    
    ; 设置列宽
    SearchHistoryListView.ModifyCol(1, 200)  ; 名称
    SearchHistoryListView.ModifyCol(2, 300)  ; 位置
    SearchHistoryListView.ModifyCol(3, 150)  ; 搜索时间
    SearchHistoryListView.ModifyCol(4, 150)  ; 创建时间
    SearchHistoryListView.ModifyCol(5, 150)  ; 修改时间
    SearchHistoryListView.ModifyCol(6, 100)  ; 类型
}
```

### 步骤5：在SwitchTab中添加搜索标签支持

**位置：** `SwitchTab` 函数（约第3884行）

**修改：**
```autohotkey
; 隐藏所有标签页内容
HideControls(GeneralTabControls)
HideControls(AppearanceTabControls)
HideControls(PromptsTabControls)
HideControls(HotkeysTabControls)
HideControls(AdvancedTabControls)
HideControls(SearchTabControls)  ; 添加搜索标签

; 显示当前标签页内容
switch TabName {
    case "general":
        ShowControls(GeneralTabControls)
    case "appearance":
        ShowControls(AppearanceTabControls)
    case "prompts":
        ShowControls(PromptsTabControls)
    case "hotkeys":
        ShowControls(HotkeysTabControls)
    case "advanced":
        ShowControls(AdvancedTabControls)
    case "search":
        ShowControls(SearchTabControls)
        RefreshSearchHistoryListView()  ; 刷新搜索历史列表
}
```

### 步骤6：创建刷新ListView函数

```autohotkey
; ===================== 刷新搜索历史ListView =====================
RefreshSearchHistoryListView(FilterText := "") {
    global SearchHistoryListView
    
    if (!SearchHistoryListView) {
        return
    }
    
    ; 清空列表
    try {
        SearchHistoryListView.Delete()
    } catch {
    }
    
    ; 获取搜索历史
    HistoryList := GetSearchHistory(500)  ; 最多500条
    
    ; 过滤数据
    FilteredList := []
    if (FilterText != "") {
        FilterLower := StrLower(FilterText)
        for Index, Item in HistoryList {
            if (InStr(StrLower(Item.Name), FilterLower) || InStr(StrLower(Item.Path), FilterLower) || InStr(StrLower(Item.Type), FilterLower)) {
                FilteredList.Push(Item)
            }
        }
    } else {
        FilteredList := HistoryList
    }
    
    ; 添加到ListView
    for Index, Item in FilteredList {
        ; 格式化时间
        SearchTimeFormatted := Item.SearchTime ? FormatTime(Item.SearchTime, "yyyy-MM-dd HH:mm:ss") : ""
        CreateTimeFormatted := Item.CreateTime ? FormatTime(Item.CreateTime, "yyyy-MM-dd HH:mm:ss") : ""
        ModifyTimeFormatted := Item.ModifyTime ? FormatTime(Item.ModifyTime, "yyyy-MM-dd HH:mm:ss") : ""
        
        SearchHistoryListView.Add("", Item.Name, Item.Path, SearchTimeFormatted, CreateTimeFormatted, ModifyTimeFormatted, Item.Type)
    }
    
    ; 重新调整列宽
    SearchHistoryListView.ModifyCol(1, "AutoHdr")
    SearchHistoryListView.ModifyCol(2, "AutoHdr")
    SearchHistoryListView.ModifyCol(3, "AutoHdr")
    SearchHistoryListView.ModifyCol(4, "AutoHdr")
    SearchHistoryListView.ModifyCol(5, "AutoHdr")
    SearchHistoryListView.ModifyCol(6, "AutoHdr")
}

; ===================== 搜索历史过滤事件 =====================
OnSearchHistoryFilter(*) {
    global SearchHistoryEdit
    if (SearchHistoryEdit) {
        RefreshSearchHistoryListView(SearchHistoryEdit.Value)
    }
}
```

### 步骤7：在主配置创建函数中调用CreateSearchTab

**位置：** 约第11448行

**修改：**
```autohotkey
CreateGeneralTab(ConfigGUI, ContentX, ContentY, ContentWidth, ContentHeight)
CreateAppearanceTab(ConfigGUI, ContentX, ContentY, ContentWidth, ContentHeight)
CreatePromptsTab(ConfigGUI, ContentX, ContentY, ContentWidth, ContentHeight)
CreateHotkeysTab(ConfigGUI, ContentX, ContentY, ContentWidth, ContentHeight)
CreateAdvancedTab(ConfigGUI, ContentX, ContentY, ContentWidth, ContentHeight)
CreateSearchTab(ConfigGUI, ContentX, ContentY, ContentWidth, ContentHeight)  ; 添加搜索标签
```

### 步骤8：更新SwitchTab函数中的控件数组引用

**位置：** `SwitchTab` 函数开头（约第3886行）

**修改：**
```autohotkey
SwitchTab(TabName) {
    global ConfigTabs, CurrentTab
    global GeneralTabControls, AppearanceTabControls, PromptsTabControls, HotkeysTabControls, AdvancedTabControls, SearchTabControls  ; 添加SearchTabControls
    ...
}
```

## 数据来源建议

搜索历史数据的来源可以有多种选择：

1. **文件搜索记录**：当用户使用Everything或其他搜索工具时记录
2. **剪贴板路径记录**：当用户复制文件路径时自动记录
3. **手动添加**：提供添加按钮让用户手动添加
4. **Cursor文件访问记录**：记录在Cursor中打开的文件

建议实现方案：**结合剪贴板路径记录和手动添加**

## 总结

### 实现工作量评估
- **数据库表创建**：15分钟
- **数据库操作函数**：30分钟
- **UI创建（标签按钮+标签页）**：45分钟
- **ListView刷新逻辑**：30分钟
- **集成和测试**：30分钟

**总计：约2.5小时**

### 关键注意事项
1. 确保数据库表在 `InitSQLiteDB()` 中正确创建
2. 文件时间获取需要使用 `FileGetTime()`，需处理异常情况
3. ListView列宽需要合理设置，避免内容被截断
4. 时间格式化需要统一格式（建议：yyyy-MM-dd HH:mm:ss）
5. 搜索过滤需要支持多字段模糊匹配
