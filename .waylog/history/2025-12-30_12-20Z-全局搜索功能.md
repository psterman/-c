# 全局搜索功能
_Exported on 12/31/2025 at 07:49:29 GMT+8 from Cursor via WayLog_


**User**

1. 彻底修复 SQLite 句柄泄露 (Stability)

重构查询函数：对 SearchClipboardHistory, GetTemplateByID 以及所有涉及 DB.Prepare 的函数进行重构。

强制规范：必须使用 try...finally 结构。确保无论是否触发 return 或异常，都在 finally 块中执行 if IsObject(ST) ST.Free()。

数据库生命周期：在脚本退出前增加 DB.CloseDB() 逻辑，确保数据缓冲区完全写入。

2. 构建统一搜索后端 (Database Architecture)

创建虚拟视图：在数据库初始化处增加 SQL 视图 v_GlobalSearch。

数据聚合：使用 UNION ALL 聚合 Prompts（提示词）和 ClipboardHistory（剪贴板）表。

统一字段：输出列需统一为 Title (标题), Content (详情), Source (来源标识), Timestamp (建立时间), OriginalID (原始行 ID)。

性能优化：为搜索相关列增加 COLLATE NOCASE 索引，支持不区分大小写的极速模糊匹配。

3. 实现“Everything 风格”即时搜索 UI (UI/UX)

新增标签页：在配置面板中增加“全域搜索”Tab 标签页。

搜索流控：

使用 Edit 控件作为搜索框，绑定 OnEvent("Change")。

引入 150ms 防抖 (Debouncing) 机制（使用 SetTimer），避免高频输入导致数据库锁定。

列表呈现：使用 ListView 展示结果（包含内容、来源、时间列），并强制使用 LIMIT 100 限制单次渲染条数。

渲染优化：在 ListView 更新前后切换 -Redraw 以消除拉伸或刷新时的闪烁。

4. 完善交互闭环 (Workflow)

双击直达逻辑：监听 ListView 的双击事件：

若 Source 为“提示词”：自动切换至对应 Tab 并定位到编辑界面。

若 Source 为“剪贴板”：执行 SetClipboardData 并自动粘贴或关闭面板。

布局自适应：确保新增的搜索界面在配置面板拉伸时能同步调整宽度。

---


**Cursor**

检查代码结构，定位数据库操作和 UI 相关代码。



继续查找相关函数和数据库操作代码：



读取关键函数实现：



继续查找配置面板创建和所有 DB.Prepare 使用位置：



创建初始任务列表，开始实现：



查找 ShowConfigGUI 函数，了解配置面板的创建方式：



查找 CreateSearchTab 函数，查看现有实现：



查看 CreateSearchTab 函数的实现：



开始实现：先修复数据库视图和索引，然后更新搜索标签页。



开始实现：先修复数据库视图和索引，然后更新搜索功能。



修复数据库视图字段，确保符合要求：



检查并修复所有 SQLite 句柄泄露问题，确保所有使用 DB.Prepare 的地方都有 try...finally：



修复 SearchGlobalView 的 SQL 查询，确保字段顺序正确，并添加退出时的数据库关闭逻辑：



修复 SearchClipboardHistory 的 Bind 调用，并添加退出时的数据库关闭逻辑：



修复 SyncPromptTemplatesToDB 和 SearchClipboardHistoryFiles 的 Bind 调用，并添加退出时的数据库关闭逻辑：



在脚本末尾添加退出时的数据库关闭逻辑：



在脚本末尾添加退出时的数据库关闭逻辑：



更新搜索标签页标题为"全域搜索"，并确保使用统一视图搜索：



检查搜索标签页的布局自适应，并确保搜索框和 ListView 能随窗口大小调整：



添加搜索标签页的布局自适应处理：



所有功能已实现。总结如下：

## 完成的功能

### 1. 修复 SQLite 句柄泄露
- 所有使用 `DB.Prepare` 的函数都已使用 `try...finally` 结构
- 在 `finally` 块中确保 `ST.Free()` 被调用
- 修复了 `SearchClipboardHistory`、`SearchGlobalView`、`SearchClipboardHistoryFiles`、`SyncPromptTemplatesToDB` 和 `CapsLockCopy` 中的 Bind 调用，明确指定类型参数

### 2. 构建统一搜索后端
- 创建了 `v_GlobalSearch` 视图，字段顺序为：`Title, Content, Source, Timestamp, OriginalID`
- 使用 `UNION ALL` 聚合 `Prompts` 和 `ClipboardHistory` 表
- 为搜索相关列添加了 `COLLATE NOCASE` 索引

### 3. 实现"Everything 风格"即时搜索 UI
- 搜索标签页标题已改为"全域搜索"
- 搜索框使用 `OnEvent("Change")` 绑定
- 实现了 150ms 防抖机制（使用 `SetTimer`）
- ListView 展示结果，使用 `LIMIT 100` 限制单次渲染条数
- 使用 `-Redraw` 和 `+Redraw` 优化渲染，减少闪烁

### 4. 完善交互闭环
- 双击事件处理已实现：
  - 若 Source 为"prompt"：自动切换至提示词 Tab 并定位到编辑界面
  - 若 Source 为"clipboard"：执行 `SetClipboardData` 并复制到剪贴板
- 布局自适应：搜索标签页的搜索框和 ListView 会随窗口大小调整

### 5. 数据库生命周期管理
- 在脚本退出前添加了 `OnExit` 处理函数，确保 `DB.CloseDB()` 被调用，数据完全写入

所有功能已实现并通过语法检查。代码已准备好使用。

---
