# 全局悬浮搜索中心
_Exported on 12/31/2025 at 07:49:29 GMT+8 from Cursor via WayLog_


**User**

d解释这段代码的核心逻辑、输入输出、关键函数作用，用新手能懂的语言，标注易错点新增“搜索中心”全局悬浮搜索
1. 搜索中心悬浮窗
创建一个名为 SearchCenter 的独立 GUI，样式为 -Caption +AlwaysOnTop（无边框置顶）。背景色使用 UI_Colors.Bg。
居中显示：激活时，窗口自动出现在屏幕正中央。极简布局：顶部是一个大字体的搜索框，下方是一个无标题栏的 ListView。确保在拉伸或结果更新时使用 -Redraw nieD避免闪烁。全局热键绑定：注册全局快捷键 CAPSLOCK + D。按下时，如果窗口可见则隐藏，不可见则显示并聚焦搜索框。自动隐藏机制：当窗口失去焦点（KillFocus）或按下 Esc 时，自动销毁或隐藏窗口。数据集成：使用之前提到的 try...finally SQLite 联合查询逻辑填充此 ListView。

2. 后端数据聚合
建立联合查询：使用 UNION ALL 逻辑，一次性检索“提示词库”、“剪贴板历史”和“面板设置项”。
统一输出结构：返回字段需包含：Title (显示名称), Content (详细内容), Source (来源: 提示词/剪贴板/设置), Time (建立时间), OriginalID (原始行ID)。
排序逻辑：按 Time 倒序排列，确保最近使用的数据排在最前面。

3. UI 性能与即时响应
防抖处理：为搜索框绑定 OnEvent("Change")，并使用 SetTimer 实现 150ms 防抖。用户输入停止后才触发数据库查询，防止界面卡顿。
渲染优化：使用 ListView 展示结果。在更新列表前调用 GuiControl("-Redraw", ResultLV)，更新后再开启，消除刷新时的闪烁。
显示限制：查询语句强制加上 LIMIT 100，保证即使有万条数据也能秒开。

4. 交互闭环（从“搜到”到“用到”）
双击/回车响应：为 ListView 增加响应事件：
如果是“提示词”：直接将内容发送到当前活动窗口，并隐藏面板。
如果是“剪贴板”：将该项内容重新存入系统剪贴板并执行粘贴，同时隐藏面板。
如果是“设置项”：自动切换到对应的 Tab 标签页并高亮显示该设置。

5. 架构稳定性改造（彻底解决句柄泄露）
强制重构 SQL 查询函数：将所有涉及 DB.Prepare 的逻辑（特别是搜索相关的）包装在 try...catch...finally 结构中。
规范释放：必须在 finally 块中执行 if IsObject(ST) ST.Free()。确保无论搜索是否成功、是否有结果，数据库句柄都会被 100% 释放。
索引优化：在数据库初始化时，为 Prompts.Name 和 ClipboardHistory.Content 增加 COLLATE NOCASE 索引，确保模糊匹配不区分大小写且速度极快。dD解释这段代码的核心逻辑、输入输出、关键函数作用，用新手能懂的语言，标注易错点解释这段代码的核心逻辑、输入输出、关键函数作用，用新手能懂的语言，标注易错点D解释这段代码的核心逻辑、输入输出、关键函数作用，用新手能懂的语言，标注易错点

---


**Cursor**

查看项目结构，了解代码组织方式。



查看主文件，了解项目结构：



继续查看数据库初始化和热键注册相关代码：



查看数据库初始化和热键注册代码：



创建代码解释文档，并实现搜索中心功能。

---
