# CapsLock 热键逻辑更新
_Exported on 12/31/2025 at 07:49:28 GMT+8 from Cursor via WayLog_


**User**

移除旧逻辑：彻底删除原来全局注册的 CapsLock + S 分割字符串代码（即 SubStr 相关的处理逻辑）。

全局方向键注册：注册全局热键 CapsLock + W/S/A/D 分别映射为系统的 Up/Down/Left/Right。

CapsLock + F 逻辑重写：

使用 KeyWait 区分长短按。长按（>300ms）激活全新的搜索中心窗口；短按则检查：若窗口已激活，执行 Enter（确认搜索）；

上下文映射：使用 #HotIf WinActive("ahk_id " . GuiID_SearchCenter) 确保当搜索窗口激活时，CapsLock + A/D 变为“翻页/组切换”功能，CapsLock + W/S 变为“区域切换”功能。

---


**Cursor**

查找主脚本文件，定位 CapsLock + S 的旧逻辑和 CapsLock + F 的实现。



继续查找相关代码：



读取关键代码段：



查找 SplitCode 函数和全局热键注册位置：



读取 SplitCode 函数的实现：



创建初始待办列表，开始实现：



开始实现修改。先添加搜索中心窗口的全局变量，然后进行其他修改：



开始实现修改：



删除 CapsLock + S 的旧逻辑，添加全局方向键注册，并重写 CapsLock + F 的逻辑：



添加全局方向键注册，并重写 CapsLock + F 的逻辑：



查找窗口创建函数作为参考，然后创建搜索中心窗口：



查找 GlobalSearchEngine 类是否已存在，然后创建搜索中心窗口：



查看 ShowClipboardManager 函数的实现，作为创建搜索中心窗口的参考：



创建 GlobalSearchEngine 类和搜索中心窗口。先查找合适的位置插入这些代码：



在 #HotIf 区域后添加上下文映射，并创建 GlobalSearchEngine 类和 ShowSearchCenter 函数：

---


**User**

请检查CapsLock + W/S/A/D 和capslock+f长短按的全局注册已经完毕了吗？

---


**Cursor**

检查 CapsLock + W/S/A/D 和 CapsLock + F 的全局注册状态：



检查这些热键是否在正确的 `#HotIf` 区域内，以及是否缺少其他部分：



检查结果：

已完成：
1. CapsLock + W/S/A/D 全局注册（18702-18720 行）
   - 在 `#HotIf GetCapsLockState()` 区域内
   - 正确映射为 Up/Down/Left/Right

2. CapsLock + F 长短按逻辑（18681-18700 行）
   - 在 `#HotIf GetCapsLockState()` 区域内
   - 使用 `KeyWait("f", "T0.3")` 区分长短按
   - 长按（>300ms）调用 `ShowSearchCenter()`
   - 短按检查窗口是否激活，激活则发送 Enter

缺失：
1. `ShowSearchCenter()` 函数未定义（仅调用）
2. 上下文映射未添加（搜索窗口激活时，CapsLock + A/D 翻页切换，CapsLock + W/S 区域切换）

继续创建 `ShowSearchCenter()` 函数并添加上下文映射：

---


**User**

请重构 ShowSearchCenter() 函数，将搜索面板升级为“分段式动作面板”：

UI 布局：

顶部（路由区）：横向显示当前选中的“搜索组名称”。预设三个组：AI 智搜（包含 DeepSeek, Claude）、常用搜索（百度, 谷歌）、社交媒体（B站, 小红书）。

中部（输入区）：一个大字体的搜索 Edit 控件。

底部（结果区）：一个 ListView，实时显示本地 SQLite 的匹配结果。

导航动作打通：

当用户按下 CapsLock + W：视角切向顶部。此时按 A/D 可以在不同搜索组之间左右切换。

当用户按下 CapsLock + S：视角切向底部 ListView。

当用户在选中“顶部搜索组”状态下按 CapsLock + F：一键并发，使用 Run 同时打开该组内所有的搜索引擎网址，并携带输入框内容。

视觉反馈：确保当前激活的区域（顶部组或底部列表）有明显的高亮区分。

---


**Cursor**

重构 `ShowSearchCenter()` 函数，创建分段式动作面板。先创建必要的组件：



在 `#HotIf` 后添加上下文映射，然后创建搜索中心窗口和相关功能：



添加搜索中心相关的全局变量，然后创建 GlobalSearchEngine 类和 ShowSearchCenter 函数：



查找合适位置插入 GlobalSearchEngine 类和 ShowSearchCenter 函数：



在自启动功能之后添加 GlobalSearchEngine 类和 ShowSearchCenter 函数：



修复代码中的问题，确保所有函数正确声明全局变量：



优化 URL 编码函数，使用更可靠的方法：



添加 `IsSearchCenterActive` 函数：



修复 `OpenSearchGroupEngines` 函数中的全局变量声明：

---


**User**

继续

---
