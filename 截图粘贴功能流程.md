# 截图粘贴功能流程说明

## 功能流程

### 1. 触发截图
- **操作**: 用户按下 `CapsLock+P`
- **执行动作**:
  - 隐藏当前显示的面板（如果存在）
  - 设置等待状态标记 `ScreenshotWaiting = true`
  - **立即显示悬浮按钮**（在截图前就显示，给用户视觉反馈）
  - 发送 `Win+Shift+S` 启动 Windows 截图工具
  - 开始监控剪贴板，等待截图完成

### 2. 用户截图
- **操作**: 用户在 Windows 截图工具中选择截图区域
- **系统行为**: 截图自动保存到系统剪贴板
- **脚本监控**: 
  - 每 200ms 检查一次剪贴板
  - 检测到图片数据（CF_BITMAP=2, CF_DIB=17, 或 PNG 格式）后：
    - 使用 `ClipboardAll()` 保存截图数据到 `ScreenshotClipboard`
    - 恢复用户之前的剪贴板内容
    - 显示提示："截图已保存，请点击悬浮面板粘贴"

### 3. 点击悬浮按钮
- **操作**: 用户点击悬浮按钮
- **执行动作**（按顺序）:
  1. **立即隐藏悬浮按钮** - 避免干扰窗口焦点
  2. 检查并激活 Cursor 窗口
  3. 按 `ESC` 关闭可能已打开的输入框
  4. 按 `Ctrl+L` 打开 Cursor 的 AI 聊天面板
  5. **智能选择截图数据**（优先使用最新数据）:
     - 先检查系统剪贴板是否有图片数据
     - 如果系统剪贴板中有图片，直接使用最新的截图（用户可能进行了新的截图）
     - 如果系统剪贴板没有图片，使用之前保存的 `ScreenshotClipboard`
  6. 验证剪贴板中图片数据已准备好
  7. **执行 `Shift+Insert` 粘贴截图**
  8. 清除等待状态和截图数据
  9. 显示成功提示

### 4. 超时处理
- 如果 30 秒内没有完成截图，自动：
  - 隐藏悬浮按钮
  - 恢复旧剪贴板
  - 清除等待状态

## 关键代码位置

### 主要函数

1. **ExecuteScreenshot()** (行 8697-8820)
   - 处理 `CapsLock+P` 快捷键触发
   - 启动截图工具并监控截图完成

2. **PasteScreenshotFromButton()** (行 8823-8932)
   - 处理悬浮按钮点击事件
   - 执行粘贴操作

3. **ShowScreenshotButton()** (行 8935-9043)
   - 创建并显示悬浮按钮

4. **HideScreenshotButton()** (行 9048-9073)
   - 隐藏并销毁悬浮按钮

## 技术细节

### 截图检测
- 使用 Windows API `IsClipboardFormatAvailable` 检测剪贴板格式
- 支持位图 (CF_BITMAP=2)、DIB (CF_DIB=17) 和 PNG 格式

### 剪贴板保存
- 使用 `ClipboardAll()` 保存完整的图片数据对象
- 保存后立即恢复用户之前的剪贴板，不影响其他操作

### 窗口激活
- 多次检查和激活 Cursor 窗口，确保粘贴时窗口处于活动状态
- 使用 `WinWaitActive` 等待窗口激活完成

### 粘贴方式
- **修改后**: 使用 `Shift+Insert` 进行粘贴
- 这是标准的粘贴快捷键，兼容性更好

## 用户交互流程

```
用户按下 CapsLock+P
    ↓
悬浮按钮立即显示
    ↓
Windows 截图工具启动
    ↓
用户选择截图区域
    ↓
截图自动保存到剪贴板
    ↓
脚本检测到截图，保存到内存
    ↓
悬浮按钮保持显示（等待用户点击）
    ↓
用户点击悬浮按钮
    ↓
按钮立即消失
    ↓
激活 Cursor 窗口
    ↓
打开 AI 聊天面板
    ↓
执行 Shift+Insert 粘贴
    ↓
完成！
```

